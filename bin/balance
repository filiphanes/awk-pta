#!/usr/bin/awk -f
# Calculates balances of accounts from preprocessed postings
# Usage:
# postings | rg "$pattern" | ./balance

BEGIN {
    OFS = "\t";
    # Build patter from args
    #for (i=1; i<=NF; i++) print $(i), id;
}

{
    if (match($4, ACCOUNT_REGEX) > 0)
        balances[$4][$3] += +$2;
    next
}

END {
    # Calculate Total
    for (tag in balances)
        for (curr in balances[tag])
            total[curr] += balances[tag][curr];

    # Propagate amounts to parents
    for (tag in balances) {
        subtag = tag;
        sub(":.*$", "", subtag);
        if (subtag == tag) break;
        for (curr in balances[tag])
            balances[subtag][curr] += balances[tag][curr];
    }

    # print account balances sorted
    PROCINFO["sorted_in"] = "@ind_str_asc";
    for (tag in balances) {
        for (curr in balances[tag]) {
            printf("%12.2f %s %s\n", balances[tag][curr], curr, tag);
        }
    }
    # Print Total
    for (curr in total) {
        printf("%12.2f %s Total\n", total[curr], curr);
    }
}
